global:
  # SMTP Configuration for Email Notifications
  smtp_smarthost: 'smtp.gmail.com:587'
  smtp_from: 'alerts@wizardsofts.com'
  smtp_auth_username: 'alerts@wizardsofts.com'
  smtp_auth_password: '${SMTP_PASSWORD}'
  smtp_require_tls: true
  
  # Default timeout for HTTP requests
  http_config:
    timeout: 10s

# Route tree for alert distribution
route:
  # Root route - default grouping and timing
  group_by: ['alertname', 'cluster', 'service', 'instance']
  group_wait: 30s          # Wait for initial alerts to batch
  group_interval: 5m       # Wait before sending update for same group
  repeat_interval: 4h      # Repeat notifications for ongoing alerts
  
  # Default receiver
  receiver: 'appwrite-webhook'
  
  # Child routes for specific alert types
  routes:
    # Critical alerts - immediate notification to all channels
    - match:
        severity: critical
      receiver: 'critical-team'
      group_wait: 10s
      group_interval: 2m
      repeat_interval: 1h
    
    # Emergency alerts - immediate escalation
    - match:
        severity: emergency
      receiver: 'critical-team'
      group_wait: 0s
      group_interval: 1m
      repeat_interval: 30m
    
    # Security alerts - route to security team
    - match:
        type: security
      receiver: 'security-team'
      group_wait: 20s
      repeat_interval: 2h
    
    # Database alerts - route to DBA team
    - match_re:
        service: '(postgresql|redis|database)'
      receiver: 'dba-team'
      group_wait: 1m
      repeat_interval: 3h
    
    # ML Operations alerts - route to MLOps team
    - match_re:
        service: '(ray|celery|model|inference)'
      receiver: 'mlops-team'
      group_wait: 1m
      repeat_interval: 3h
    
    # Warning alerts - less frequent notifications
    - match:
        severity: warning
      receiver: 'warning-team'
      group_wait: 5m
      group_interval: 10m
      repeat_interval: 12h

# Inhibition rules - suppress alerts based on dependencies
inhibit_rules:
  # If critical alert fires, suppress warning for same alert
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname', 'instance']
  
  # If server is down, suppress all other alerts from that instance
  - source_match:
      alertname: 'ServerDown'
    target_match_re:
      alertname: '.*'
    equal: ['instance']

# Receiver definitions
receivers:
  # Appwrite webhook receiver - primary notification channel
  - name: 'appwrite-webhook'
    webhook_configs:
      - url: 'https://appwrite.wizardsofts.com/v1/functions/alert-processor/executions'
        send_resolved: true
        http_config:
          bearer_token: '${APPWRITE_API_KEY}'
          tls_config:
            insecure_skip_verify: false
  
  # Critical team - multi-channel notification
  - name: 'critical-team'
    webhook_configs:
      - url: 'https://appwrite.wizardsofts.com/v1/functions/alert-processor/executions'
        send_resolved: true
        http_config:
          bearer_token: '${APPWRITE_API_KEY}'
    email_configs:
      - to: 'devops@wizardsofts.com,oncall@wizardsofts.com'
        headers:
          Subject: '[CRITICAL] {{ .GroupLabels.alertname }} on {{ .GroupLabels.instance }}'
        html: |
          <h2 style="color: red;">CRITICAL ALERT</h2>
          <p><strong>Alert:</strong> {{ .GroupLabels.alertname }}</p>
          <p><strong>Instance:</strong> {{ .GroupLabels.instance }}</p>
          <p><strong>Severity:</strong> {{ .CommonLabels.severity }}</p>
          <p><strong>Description:</strong> {{ range .Alerts }}{{ .Annotations.description }}<br/>{{ end }}</p>
          <p><strong>Runbook:</strong> {{ range .Alerts }}{{ .Annotations.runbook }}<br/>{{ end }}</p>
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL}'
        channel: '#critical-alerts'
        title: 'CRITICAL: {{ .GroupLabels.alertname }}'
        text: '{{ range .Alerts }}{{ .Annotations.description }}{{ end }}'
        color: 'danger'
  
  # Security team receiver
  - name: 'security-team'
    email_configs:
      - to: 'security@wizardsofts.com'
        headers:
          Subject: '[SECURITY] {{ .GroupLabels.alertname }} detected'
        html: |
          <h2 style="color: orange;">Security Alert</h2>
          <p><strong>Alert:</strong> {{ .GroupLabels.alertname }}</p>
          <p><strong>Instance:</strong> {{ .GroupLabels.instance }}</p>
          <p><strong>Details:</strong> {{ range .Alerts }}{{ .Annotations.description }}<br/>{{ end }}</p>
    webhook_configs:
      - url: 'https://appwrite.wizardsofts.com/v1/functions/alert-processor/executions'
        send_resolved: true
        http_config:
          bearer_token: '${APPWRITE_API_KEY}'
  
  # DBA team receiver
  - name: 'dba-team'
    email_configs:
      - to: 'dba@wizardsofts.com'
        headers:
          Subject: '[DATABASE] {{ .GroupLabels.alertname }}'
        html: |
          <h2>Database Alert</h2>
          <p><strong>Service:</strong> {{ .GroupLabels.service }}</p>
          <p><strong>Instance:</strong> {{ .GroupLabels.instance }}</p>
          <p><strong>Description:</strong> {{ range .Alerts }}{{ .Annotations.description }}<br/>{{ end }}</p>
    webhook_configs:
      - url: 'https://appwrite.wizardsofts.com/v1/functions/alert-processor/executions'
        send_resolved: true
        http_config:
          bearer_token: '${APPWRITE_API_KEY}'
  
  # MLOps team receiver
  - name: 'mlops-team'
    email_configs:
      - to: 'mlops@wizardsofts.com'
        headers:
          Subject: '[MLOPS] {{ .GroupLabels.alertname }}'
        html: |
          <h2>ML Operations Alert</h2>
          <p><strong>Service:</strong> {{ .GroupLabels.service }}</p>
          <p><strong>Instance:</strong> {{ .GroupLabels.instance }}</p>
          <p><strong>Description:</strong> {{ range .Alerts }}{{ .Annotations.description }}<br/>{{ end }}</p>
    webhook_configs:
      - url: 'https://appwrite.wizardsofts.com/v1/functions/alert-processor/executions'
        send_resolved: true
        http_config:
          bearer_token: '${APPWRITE_API_KEY}'
  
  # Warning team - less urgent notifications
  - name: 'warning-team'
    email_configs:
      - to: 'devops@wizardsofts.com'
        headers:
          Subject: '[WARNING] {{ .GroupLabels.alertname }}'
        html: |
          <h2 style="color: #FFA500;">Warning Alert</h2>
          <p><strong>Alert:</strong> {{ .GroupLabels.alertname }}</p>
          <p><strong>Instance:</strong> {{ .GroupLabels.instance }}</p>
          <p><strong>Description:</strong> {{ range .Alerts }}{{ .Annotations.description }}<br/>{{ end }}</p>

# Templates for alert notifications (optional)
templates:
  - '/etc/alertmanager/templates/*.tmpl'
