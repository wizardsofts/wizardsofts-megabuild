# Hadith Knowledge Graph - CI/CD Pipeline
# Automated deployment to Server 84 via Docker

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: ""
  APP_NAME: hadith-knowledge-graph
  DEPLOY_HOST: "10.0.0.84"
  DEPLOY_USER: wizardsofts

stages:
  - security
  - test
  - build
  - deploy

# ============================================
# SECURITY SCANNING (MANDATORY)
# ============================================

security:dependency-scan:
  stage: security
  image: python:3.11-slim
  script:
    - pip install pip-audit safety bandit
    - echo "ðŸ” Running pip-audit..."
    - pip-audit --desc || exit 1
    - echo "ðŸ” Running safety check..."
    - safety check || exit 1
    - echo "ðŸ” Running bandit code scan..."
    - bandit -r src/ -ll || exit 1
    - echo "âœ… Security scans passed"
  only:
    - branches
  allow_failure: false

security:docker-scan:
  stage: security
  image: aquasec/trivy:latest
  script:
    - echo "ðŸ” Scanning Python base image..."
    - trivy image --severity HIGH,CRITICAL python:3.11-slim --exit-code 1
  only:
    - branches
  allow_failure: false

# ============================================
# UNIT TESTS
# ============================================

test:unit:
  stage: test
  image: python:3.11-slim
  services:
    - postgres:15-alpine
  variables:
    POSTGRES_DB: test_hadith
    POSTGRES_USER: test_user
    POSTGRES_PASSWORD: test_password
  before_script:
    - apt-get update && apt-get install -y gcc g++ postgresql-client
    - pip install -r requirements.txt
    - pip install pytest pytest-cov
  script:
    - pytest tests/ -v --cov=src --cov-report=term-missing
  coverage: '/TOTAL.*\s+(\d+%)$/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
  only:
    - branches

# ============================================
# BUILD DOCKER IMAGE
# ============================================

build:docker:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - cd apps/hadith-knowledge-graph
    - docker build -f infrastructure/Dockerfile.extraction -t $CI_REGISTRY_IMAGE/hadith-extraction:$CI_COMMIT_SHA .
    - docker build -f infrastructure/Dockerfile.extraction -t $CI_REGISTRY_IMAGE/hadith-extraction:latest .
    - docker push $CI_REGISTRY_IMAGE/hadith-extraction:$CI_COMMIT_SHA
    - docker push $CI_REGISTRY_IMAGE/hadith-extraction:latest
  only:
    - master
    - feature/hadith-knowledge-graph

# ============================================
# DEPLOY TO SERVER 84
# ============================================

deploy:infrastructure:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client
    - mkdir -p ~/.ssh
    - echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - ssh-keyscan -H $DEPLOY_HOST >> ~/.ssh/known_hosts
  script:
    - echo "ðŸš€ Deploying infrastructure services to Server 84..."

    # Deploy Neo4j + ChromaDB
    - |
      ssh $DEPLOY_USER@$DEPLOY_HOST << 'EOF'
        cd /opt/wizardsofts-megabuild/apps/hadith-knowledge-graph/infrastructure

        # Stop existing services
        docker-compose down

        # Start services
        docker-compose up -d neo4j chromadb

        # Wait for health checks
        echo "â³ Waiting for services to be healthy..."
        sleep 30

        # Verify services
        docker ps | grep hadith-neo4j
        docker ps | grep hadith-chromadb

        echo "âœ… Infrastructure deployed successfully"
      EOF
  only:
    - master
  when: manual
  environment:
    name: production
    url: http://10.0.0.84:7474

deploy:extraction-worker:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client
    - mkdir -p ~/.ssh
    - echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - ssh-keyscan -H $DEPLOY_HOST >> ~/.ssh/known_hosts
  script:
    - echo "ðŸš€ Deploying extraction worker to Server 84..."

    - |
      ssh $DEPLOY_USER@$DEPLOY_HOST << 'EOF'
        cd /opt/wizardsofts-megabuild/apps/hadith-knowledge-graph/infrastructure

        # Pull latest code
        git pull origin master

        # Deploy extraction worker
        docker-compose -f docker-compose.extraction.yml down
        docker-compose -f docker-compose.extraction.yml pull
        docker-compose -f docker-compose.extraction.yml up -d

        # Verify deployment
        docker ps | grep hadith-extraction-worker

        echo "âœ… Extraction worker deployed successfully"
      EOF
  only:
    - master
  when: manual
  dependencies:
    - build:docker

deploy:shared-ollama:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client
    - mkdir -p ~/.ssh
    - echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - ssh-keyscan -H $DEPLOY_HOST >> ~/.ssh/known_hosts
  script:
    - echo "ðŸš€ Deploying shared Ollama to Server 84..."

    - |
      ssh $DEPLOY_USER@$DEPLOY_HOST << 'EOF'
        cd /opt/wizardsofts-megabuild/infrastructure/ollama

        # Deploy Ollama
        docker-compose up -d

        # Wait for Ollama to start
        sleep 10

        # Pull required models (only if not already downloaded)
        docker exec ollama ollama list | grep llama3.2 || \
          docker exec ollama ollama pull llama3.2:3b-instruct-q4_K_M

        docker exec ollama ollama list | grep nomic-embed-text || \
          docker exec ollama ollama pull nomic-embed-text

        echo "âœ… Shared Ollama deployed successfully"
      EOF
  only:
    - master
  when: manual

# ============================================
# RUN EXTRACTION JOB
# ============================================

run:extraction-test:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client
    - mkdir -p ~/.ssh
    - echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - ssh-keyscan -H $DEPLOY_HOST >> ~/.ssh/known_hosts
  script:
    - echo "ðŸ§ª Running extraction test on Server 84..."

    - |
      ssh $DEPLOY_USER@$DEPLOY_HOST << 'EOF'
        cd /opt/wizardsofts-megabuild/apps/hadith-knowledge-graph

        # Run single hadith extraction test
        docker exec hadith-extraction-worker python scripts/test_single_hadith.py

        echo "âœ… Extraction test completed"
      EOF
  only:
    - master
  when: manual
